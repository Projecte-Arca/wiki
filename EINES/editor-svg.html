<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Editor SVG Pro (Versió Estable i Avançada)</title>
  <style>
    :root { --main-blue: #007bff; --light-gray: #f0f0f0; --dark-gray: #4a4a4a; --danger-red: #dc3545; --bg-color: #f4f4f8; --panel-bg: #fff; --header-bg: #eee; --border-color: #ccc; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    body { display: flex; flex-direction: column; background-color: var(--bg-color); }
    h1 { text-align: center; margin: 0.5rem 0; font-size: 1.5rem; color: #333; }
    #toolbar { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; padding: 0.5rem; background: var(--panel-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tool-group { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
    #toolbar button { background: var(--light-gray); border: 1px solid transparent; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; transition: background-color 0.2s; }
    #toolbar button:hover:not(:disabled) { background-color: #e2e6ea; }
    #toolbar button svg { width: 24px; height: 24px; fill: var(--dark-gray); pointer-events: none; }
    #toolbar button.active { background: var(--main-blue); } #toolbar button.active svg { fill: white; }
    #toolbar button:disabled { opacity: 0.4; cursor: not-allowed; }
    
    #main-content { display: flex; flex: 1; gap: 1rem; padding: 1rem; box-sizing: border-box; min-height: 0; }
    #left-panels, #right-panels { flex: 0 0 280px; display: flex; flex-direction: column; gap: 1rem; }
    #preview-container { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; background: #333; overflow: hidden; }
    .panel { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; background: var(--panel-bg); overflow: hidden; }
    .panel-header { font-size: 1rem; text-align: center; padding: 0.5rem; margin: 0; background: var(--header-bg); border-bottom: 1px solid var(--border-color); font-weight: bold; }
    .panel-content-wrapper { flex-grow: 1; position: relative; overflow: auto; padding: 0.5rem; }
    
    #preview { display: flex; align-items: center; justify-content: center; padding: 0; flex-grow: 1; position: relative; }
    #preview-svg-wrapper { position: absolute; }
    svg { transform-origin: 0 0; touch-action: none; display: block; overflow: visible; }
    
    #metadata-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .meta-tab { padding: 0.5rem 1rem; cursor: pointer; background: var(--light-gray); }
    .meta-tab.active { background: var(--panel-bg); border: 1px solid var(--border-color); border-bottom: 1px solid var(--panel-bg); margin-bottom: -1px; }
    .meta-content { display: none; } .meta-content.active { display: block; }

    #metadata-form-selection, #metadata-form-doc { display: flex; flex-direction: column; gap: 0.75rem; padding-top: 0.5rem; }
    .meta-form label { font-weight: bold; font-size: 0.9rem; }
    .meta-form input, .meta-form textarea, .meta-form select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .meta-form input:disabled, .meta-form textarea:disabled, .meta-form select:disabled { background-color: #e9ecef; cursor: not-allowed; }

    #transform-box { position: absolute; border: 1px solid var(--main-blue); pointer-events: none; display: none; z-index: 1000; }
    .handle { position: absolute; width: 10px; height: 10px; background-color: white; border: 1px solid var(--main-blue); pointer-events: all; }
    #selection-box { position: absolute; background: rgba(0, 123, 255, 0.2); border: 1px solid var(--main-blue); pointer-events: none; z-index: 1000; }
  </style>
</head>
<body>
  <h1>Editor SVG Pro</h1>
  <div id="toolbar"><!-- Filled by JS --></div>
  <div id="main-content">
    <div id="left-panels">
        <div id="objects-list-container" class="panel"><h2 class="panel-header">Objectes</h2><div class="panel-content-wrapper"><ol id="objects-list"></ol></div></div>
        <div id="metadata-container" class="panel">
            <div id="metadata-tabs">
                <div class="meta-tab active" data-tab="selection">Selecció</div>
                <div class="meta-tab" data-tab="doc">Document</div>
            </div>
            <div class="panel-content-wrapper">
                <div id="meta-content-selection" class="meta-content active"><form id="metadata-form-selection" class="meta-form"><!-- Filled by JS --></form></div>
                <div id="meta-content-doc" class="meta-content"><form id="metadata-form-doc" class="meta-form"><!-- Filled by JS --></form></div>
            </div>
        </div>
    </div>
    <div id="preview-container">
      <h2 class="panel-header">Llenç</h2>
      <div id="preview">
        <div id="preview-svg-wrapper"></div>
        <div id="transform-box"><div class="handle rotate"></div><div class="handle resize nw"></div><div class="handle resize ne"></div><div class="handle resize sw"></div><div class="handle resize se"></div></div>
      </div>
    </div>
    <div id="right-panels">
        <div id="library-container" class="panel"><h2 class="panel-header">Biblioteca</h2><div class="panel-content-wrapper">Properament...</div></div>
        <div id="editor-container" class="panel"><h2 class="panel-header">Codi SVG</h2><textarea id="svgEditor" spellcheck="false"></textarea></div>
    </div>
  </div>
  
  <script>
    // --- ESTAT DE L'APLICACIÓ ---
    const get = id => document.getElementById(id);
    const editorEl = get('svgEditor'), previewEl = get('preview'), transformBoxEl = get('transform-box'), objectsListEl = get('objects-list'), svgWrapperEl = get('preview-svg-wrapper');
    const metadataTabs = get('metadata-tabs');
    let svgEl;
    let currentTool = 'tool-select', objectCounters = {};
    let isDrawing = false, isPanning = false, isMoving = false, isMarqueeSelecting = false, isTransforming = false;
    let startX = 0, startY = 0, panX = 0, panY = 0, zoom = 1;
    let selectedElements = [], history = [], historyIndex = -1;
    let strokeColor = 'black', fillColor = 'transparent';
    let transformState = {};

    // --- INICIALITZACIÓ ---
    function initialize() {
        populateUI();
        setupEventListeners();
        loadSVG('<svg xmlns="http://www.w3.org/2000/svg" id="canvas" width="800" height="600" data-name="Nou Document" style="background-color: white;"><defs></defs></svg>');
        selectTool('tool-select');
        updateColorIndicators();
    }
    
    // --- POBLAR I CONFIGURAR LA INTERFÍCIE ---
    function populateUI() {
        // Omple la barra d'eines per mantenir l'HTML net.
        get('toolbar').innerHTML = `
            <div class="tool-group"><button id="tool-select" title="Seleccionar (V)"><svg viewBox="0 0 24 24"><path d="M13.79,2.43L15.21,3.84L5.43,13.62L3.62,12.21L13.79,2.43M16,16.59L19.59,13L21,14.41L14.41,21L13,19.59L16,16.59M3,18.5L5.5,21H11.5L9.5,19H6.5L3,18.5Z" /></svg></button><button id="selectAllBtn" title="Seleccionar Tot (Ctrl+A)"><svg viewBox="0 0 24 24"><path d="M2,2H11V6H9V4H4V9H6V11H2V2M22,13H18V11H20V9H15V13H13V22H22V13M4,13V15H9V20H11V15H13V13H4Z"/></svg></button></div>
            <div class="tool-group"><button id="tool-pen" title="Ploma (P)"><svg viewBox="0 0 24 24"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z" /></svg></button><button id="tool-rect" title="Rectangle (R)"><svg viewBox="0 0 24 24"><path d="M4,4H20V20H4V4M6,6V18H18V6H6Z" /></svg></button><button id="tool-circle" title="Cercle (C)"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4Z" /></svg></button><button id="tool-line" title="Línia (L)"><svg viewBox="0 0 24 24"><path d="M4,11V13H20V11H4Z" /></svg></button><button id="tool-fill" title="Pot de Pintura (F)"><svg viewBox="0 0 24 24"><path d="M17.74,12.03L19,10.77L14.77,6.54L13.5,7.81L14.92,9.23L12,12.14L9.12,9.26L7.7,10.68L10.59,13.57L4.22,20H6L12,14L17.74,12.03M21,2L17,6L18,7L22,3L21,2Z"/></svg></button></div>
            <div class="tool-group" id="color-controls"><button id="strokeColorToggle" title="Color de Traç (S)"><span class="color-indicator"></span>Traç</button><button id="fillColorToggle" title="Color d'Omplir (D)"><span class="color-indicator"></span>Omplir</button></div>
            <div class="tool-group"><button id="deleteBtn" title="Eliminar (Supr)" disabled><svg viewBox="0 0 24 24" style="fill: var(--danger-red);"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,19V6H17V19H7Z" /></svg></button><button id="bringToFrontBtn" title="Portar al Davant" disabled><svg viewBox="0 0 24 24"><path d="M2,6H12V8H2V6M2,10H10V12H2V10M2,14H10V16H2V14M16,2H4V4H16V2M22,6H14V8H22V6M20,10H14V12H20V10M20,14H14V16H20V14Z" /></svg></button><button id="sendToBackBtn" title="Enviar al Fons" disabled><svg viewBox="0 0 24 24"><path d="M2,16H10V14H2V16M2,12H12V10H2V12M2,8H12V6H2V8M14,14V4H4V2H14A2,2 0 0,1 16,4V14H14M22,8H18V4H20V2H18A2,2 0 0,0 16,4V8H14V10H16V14H18V10H20V14H22V12H20V8Z" /></svg></button></div>
            <div class="tool-group"><button id="undoBtn" title="Desfer (Ctrl+Z)" disabled><svg viewBox="0 0 24 24"><path d="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z" /></svg></button><button id="redoBtn" title="Refer (Ctrl+Y)" disabled><svg viewBox="0 0 24 24"><path d="M18.4,10.6C16.55,9 14.15,8 11.5,8C6.85,8 2.92,11.03 1.53,15.22L3.9,16C4.95,12.81 7.96,10.5 11.5,10.5C13.46,10.5 15.23,11.22 16.62,12.38L13,16H22V7L18.4,10.6Z" /></svg></button></div>
            <div class="tool-group"><button id="saveBtn" title="Guardar SVG"><svg viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" /></svg></button><button id="importBtn" title="Importar SVG"><svg viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg></button><input type="file" id="file-importer" accept="image/svg+xml"></div>`;

        // Omple els formularis de metadades.
        const metaFieldsHTML = `
            <label for="{idPrefix}-name">Nom</label><input type="text" id="{idPrefix}-name" data-meta="name">
            <label for="{idPrefix}-desc">Descripció</label><textarea id="{idPrefix}-desc" data-meta="desc"></textarea>
            <label for="{idPrefix}-tags">Tags (separats per coma)</label><input type="text" id="{idPrefix}-tags" data-meta="tags">
            <label for="{idPrefix}-llosa">Descrit en Llosa</label><input type="text" id="{idPrefix}-llosa" data-meta="llosa">
            <label for="{idPrefix}-scope">Àmbit</label>
            <select id="{idPrefix}-scope" data-meta="scope">
                <option value="general">General</option><option value="matematiques">Matemàtiques</option><option value="astronomia">Astronomia</option><option value="quimica">Química</option><option value="logica">Lògica</option><option value="fisica">Física</option><option value="altres">Altres</option>
            </select>`;
        get('metadata-form-selection').innerHTML = metaFieldsHTML.replace(/{idPrefix}/g, 'sel');
        get('metadata-form-doc').innerHTML = metaFieldsHTML.replace(/{idPrefix}/g, 'doc');
    }

    function setupEventListeners() {
        // Assigna funcions als botons i eines.
        const listeners = { 'undoBtn': undo, 'redoBtn': redo, 'deleteBtn': deleteSelection, 'selectAllBtn': selectAllElements, 'bringToFrontBtn': () => layerSelected(true), 'sendToBackBtn': () => layerSelected(false), 'saveBtn': save, 'importBtn': triggerImport };
        Object.entries(listeners).forEach(([id, func]) => get(id).addEventListener('click', func));
        document.querySelectorAll('#toolbar button[id^="tool-"]').forEach(btn => btn.addEventListener('click', () => selectTool(btn.id)));
        get('strokeColorToggle').addEventListener('click', () => toggleColor('stroke'));
        get('fillColorToggle').addEventListener('click', () => toggleColor('fill'));
        get('file-importer').addEventListener('change', importFile);
        editorEl.addEventListener('input', () => loadSVG(editorEl.value, false));
        
        // Esdeveniments del llenç (ratolí i tàctil).
        ['mousedown', 'touchstart'].forEach(evt => previewEl.addEventListener(evt, handlePointerDown, { passive: false }));
        ['mousemove', 'touchmove'].forEach(evt => window.addEventListener(evt, handlePointerMove, { passive: false }));
        ['mouseup', 'touchend', 'touchcancel'].forEach(evt => window.addEventListener(evt, handlePointerUp, { passive: false }));
        previewEl.addEventListener('wheel', handleWheel, { passive: false });
        
        // Nanses de transformació.
        transformBoxEl.querySelectorAll('.handle').forEach(handle => { handle.addEventListener('mousedown', e => handleTransformStart(e, handle.className)); handle.addEventListener('touchstart', e => handleTransformStart(e, handle.className)); });
        
        // Panells laterals.
        objectsListEl.addEventListener('click', e => { if (e.target.tagName === 'LI') { const el = svgEl.querySelector('#' + e.target.dataset.id); if (el) { if (e.shiftKey) { toggleSelection(el); } else { selectElement(el); } } } });
        metadataTabs.addEventListener('click', e => { if (e.target.classList.contains('meta-tab')) switchMetaTab(e.target.dataset.tab); });
        get('metadata-form-selection').addEventListener('input', e => updateMetadata(e.target, selectedElements[0]));
        get('metadata-form-doc').addEventListener('input', e => updateMetadata(e.target, svgEl));

        // Teclat.
        window.addEventListener('keydown', handleKeyPress);
    }
    
    // --- LÒGICA D'ESDEVENIMENTS ---
    // ... (El codi de handlePointerDown, handlePointerMove, handlePointerUp, handleKeyPress, handleWheel roman molt similar a la versió anterior) ...
     function handlePointerDown(e) {
        if (e.target.closest('.handle')) return;
        const { x, y, originalEvent: oe } = getPoint(e);
        if (oe.button === 1 || (oe.touches && oe.touches.length === 2)) { isPanning = true; const c = oe.touches ? oe.touches[0] : oe; startX = c.clientX; startY = c.clientY; return; }
        startX = x; startY = y;
        const target = oe.target.closest('rect, circle, path, line, g');

        if (currentTool === 'tool-select') {
            if (target && isValidElement(target)) { isMoving = true; if (oe.shiftKey) { toggleSelection(target); } else if (!selectedElements.includes(target)) { selectElement(target); } }
            else { isMarqueeSelecting = true; const r = previewEl.getBoundingClientRect(); createSelectionBox(oe.clientX - r.left, oe.clientY - r.top); deselectAll(); }
        } else if (currentTool === 'tool-fill' && target && isValidElement(target)) {
            target.setAttribute('fill', fillColor); pushHistory();
        } else if (currentTool !== 'tool-select' && currentTool !== 'tool-fill') {
            deselectAll(); isDrawing = true; if (currentTool === 'tool-pen') createPath(x,y); else createShape(currentTool.replace('tool-',''), x,y);
        }
    }

    function handlePointerMove(e) {
        if (isPanning) { const c=e.touches?e.touches[0]:e; panX+=c.clientX-startX; panY+=c.clientY-startY; startX=c.clientX; startY=c.clientY; applyTransform(); return; }
        const { x, y, originalEvent: oe } = getPoint(e);
        if (isTransforming) { handleTransform(oe); }
        else if (isMoving && selectedElements.length > 0) { moveSelected(x - startX, y - startY); startX = x; startY = y; }
        else if (isMarqueeSelecting) { const r = previewEl.getBoundingClientRect(); updateSelectionBox(oe.clientX - r.left, oe.clientY - r.top); }
        else if (isDrawing) { const u = {'tool-rect':updateRect, 'tool-circle':updateCircle, 'tool-line':updateLine, 'tool-pen':updatePath}; u[currentTool]?.(x,y); }
    }
    
    function handlePointerUp() {
        if (isDrawing || isMoving || isTransforming) pushHistory();
        if (isMarqueeSelecting) selectInMarquee();
        isDrawing = isPanning = isMoving = isMarqueeSelecting = isTransforming = false;
        if(currentEl) { selectElement(currentEl); currentEl = null; }
        removeSelectionBox();
    }
    
    function handleKeyPress(e) {
        if (document.activeElement === editorEl || document.activeElement.closest('.meta-form')) return;
        const keyActions = { Delete: deleteSelection, Backspace: deleteSelection };
        if (keyActions[e.key]) { e.preventDefault(); keyActions[e.key](); return; }
        if (e.ctrlKey) {
            const ctrlActions = { a: selectAllElements, z: undo, y: redo };
            if (ctrlActions[e.key]) { e.preventDefault(); ctrlActions[e.key](); return; }
        }
        const toolKeys = { v: 'tool-select', p: 'tool-pen', r: 'tool-rect', c: 'tool-circle', l: 'tool-line', f: 'tool-fill' };
        if (toolKeys[e.key]) { e.preventDefault(); selectTool(toolKeys[e.key]); }
        const colorKeys = { s: () => toggleColor('stroke'), d: () => toggleColor('fill') };
        if (colorKeys[e.key]) { e.preventDefault(); colorKeys[e.key](); }
    }


    // --- DIBUIX I MANIPULACIÓ ---
     function createShape(type, x, y) {
        objectCounters[type] = (objectCounters[type] || 0) + 1;
        const id = `${type}_${objectCounters[type]}`;
        const newEl = document.createElementNS('http://www.w3.org/2000/svg', type);
        newEl.id = id;
        newEl.dataset.name = id.replace('_', ' ');
        newEl.setAttribute('stroke', strokeColor); newEl.setAttribute('stroke-width', '2'); newEl.setAttribute('fill', type === 'line' ? 'none' : fillColor);
        const attr = { rect: {x,y,width:0,height:0}, circle: {cx:x,cy:y,r:0}, line: {x1:x,y1:y,x2:x,y2:y} };
        Object.entries(attr[type]).forEach(([k,v]) => newEl.setAttribute(k,v));
        svgEl.appendChild(newEl);
        currentEl = newEl; // Assigna a la variable global per a l'actualització.
    }
    function createPath(x,y) { objectCounters.path = (objectCounters.path || 0) + 1; const id = `path_${objectCounters.path}`; let pathData = `M${x.toFixed(2)},${y.toFixed(2)}`; const newEl = document.createElementNS('http://www.w3.org/2000/svg', 'path'); newEl.id = id; newEl.dataset.name = id.replace('_', ' '); newEl.setAttribute('d', pathData); newEl.setAttribute('stroke', strokeColor); newEl.setAttribute('stroke-width', '2'); newEl.setAttribute('fill', 'none'); svgEl.appendChild(newEl); currentEl = newEl; }
    const updateRect = (x,y) => { const w=x-startX, h=y-startY; currentEl.setAttribute('width',Math.abs(w)); currentEl.setAttribute('height',Math.abs(h)); if(w<0)currentEl.setAttribute('x',x); if(h<0)currentEl.setAttribute('y',y); };
    const updateCircle = (x,y) => currentEl.setAttribute('r', Math.hypot(x - startX, y - startY));
    const updateLine = (x,y) => { currentEl.setAttribute('x2', x); currentEl.setAttribute('y2', y); };
    const updatePath = (x,y) => { currentEl.setAttribute('d', currentEl.getAttribute('d') + ` L${x.toFixed(2)},${y.toFixed(2)}`); };
    function selectTool(toolId) { document.querySelector('#toolbar button.active')?.classList.remove('active'); get(toolId).classList.add('active'); currentTool = toolId; deselectAll(); }
    const isValidElement = el => el && el.id !== 'canvas' && el.ownerSVGElement;
    function deselectAll() { selectedElements.forEach(el => el.classList.remove('selected-indicator')); selectedElements = []; updateUI(); }
    function selectElement(el) { deselectAll(); selectedElements.push(el); el.classList.add('selected-indicator'); updateUI(); }
    function toggleSelection(el) { const i = selectedElements.indexOf(el); if(i > -1){ el.classList.remove('selected-indicator'); selectedElements.splice(i,1); } else { selectedElements.push(el); el.classList.add('selected-indicator'); } updateUI(); }
    function selectAllElements() { deselectAll(); svgEl.querySelectorAll('rect,circle,line,path,g').forEach(el => selectedElements.push(el)); selectedElements.forEach(el => el.classList.add('selected-indicator')); updateUI(); }
    function deleteSelection() { if (!selectedElements.length) return; selectedElements.forEach(el => el.remove()); deselectAll(); pushHistory(); }
    function moveSelected(dx, dy) { selectedElements.forEach(el => applySingleTransform(el, {dx, dy})); updateUI(false); }
    function layerSelected(toFront) { if (!selectedElements.length) return; selectedElements.forEach(el => { if (toFront) svgEl.appendChild(el); else svgEl.insertBefore(el, svgEl.querySelector('defs')?.nextSibling || svgEl.firstChild); }); pushHistory(); }
    
    // --- GESTIÓ DE LA INTERFÍCIE (UI) ---
    function updateUI(updateAll = true) {
        const hasSelection = selectedElements.length > 0;
        const isSingleSelection = selectedElements.length === 1;
        
        get('deleteBtn').disabled = !hasSelection; get('bringToFrontBtn').disabled = !hasSelection; get('sendToBackBtn').disabled = !hasSelection;
        
        // Activa/desactiva els formularis de metadades.
        get('metadata-form-selection').querySelectorAll('input, textarea, select').forEach(i => i.disabled = !isSingleSelection);
        if (isSingleSelection) { populateMetadataForm(selectedElements[0]); } else { clearMetadataForm('sel'); }
        populateMetadataForm(svgEl, 'doc'); // Sempre mostra les dades del document.

        if (updateAll) updateObjectsList();
        drawTransformBox();
        updateEditor();
    }
    
    function updateObjectsList() { objectsListEl.innerHTML = ''; Array.from(svgEl.children).filter(el => isValidElement(el)).forEach(el => { const li = document.createElement('li'); li.textContent = el.dataset.name || el.id; li.dataset.id = el.id; if (selectedElements.includes(el)) li.classList.add('selected'); objectsListEl.appendChild(li); }); }

    // --- METADADES ---
    function switchMetaTab(tabName) {
        document.querySelectorAll('.meta-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.meta-tab[data-tab="${tabName}"]`).classList.add('active');
        document.querySelectorAll('.meta-content').forEach(c => c.classList.remove('active'));
        get(`meta-content-${tabName}`).classList.add('active');
    }

    function populateMetadataForm(el, prefix) {
        if (!el) return;
        const formId = prefix ? `metadata-form-${prefix}` : 'metadata-form-selection';
        const form = get(formId);
        form.querySelectorAll('input, textarea, select').forEach(input => {
            const metaKey = input.dataset.meta;
            input.value = el.dataset[metaKey] || '';
        });
    }

    function clearMetadataForm(prefix) {
        const formId = `metadata-form-${prefix}`;
        get(formId).querySelectorAll('input, textarea, select').forEach(input => input.value = '');
        get(`${prefix}-scope`).value = 'general';
    }

    function updateMetadata(formInput, targetElement) {
        if (!targetElement) return;
        const metaKey = formInput.dataset.meta;
        targetElement.dataset[metaKey] = formInput.value;
        if (metaKey === 'name') updateObjectsList();
        // Les dades es guarden a l'historial en la propera acció de l'usuari.
    }
    
    // --- TRANSFORMACIONS ---
    function getCollectiveBBox() {
        if (selectedElements.length === 0) return null;
        const collectiveRect = { left: Infinity, top: Infinity, right: -Infinity, bottom: -Infinity };
        selectedElements.forEach(el => {
            const rect = el.getBoundingClientRect();
            collectiveRect.left = Math.min(collectiveRect.left, rect.left);
            collectiveRect.top = Math.min(collectiveRect.top, rect.top);
            collectiveRect.right = Math.max(collectiveRect.right, rect.right);
            collectiveRect.bottom = Math.max(collectiveRect.bottom, rect.bottom);
        });
        const rotation = selectedElements.length === 1 ? parseTransform(selectedElements[0].getAttribute('transform')).angle : 0;
        return { x: collectiveRect.left, y: collectiveRect.top, width: collectiveRect.right - collectiveRect.left, height: collectiveRect.bottom - collectiveRect.top, rotation };
    }

    function drawTransformBox() {
        const bbox = getCollectiveBBox();
        if (!bbox || bbox.width === 0 && bbox.height === 0) { transformBoxEl.style.display = 'none'; return; }
        const previewRect = previewEl.getBoundingClientRect();
        Object.assign(transformBoxEl.style, { display: 'block', left: `${bbox.x - previewRect.left}px`, top: `${bbox.y - previewRect.top}px`, width: `${bbox.width}px`, height: `${bbox.height}px`, transform: `rotate(${bbox.rotation}deg)` });
    }
    
    function handleTransformStart(e, handleClass) { e.stopPropagation(); isTransforming = true; const bbox = getCollectiveBBox(); const center = { x: bbox.x + bbox.width / 2, y: bbox.y + bbox.height / 2 }; const { clientX, clientY } = e.touches ? e.touches[0] : e; transformState = { handle: handleClass, bbox, center, startMouseX: clientX, startMouseY: clientY, startAngle: Math.atan2(clientY - center.y, clientX - center.x), initialTransforms: selectedElements.map(el => parseTransform(el.getAttribute('transform'))) }; }
    function handleTransform(event) {
        const { handle, bbox, center, startAngle, initialTransforms, startMouseX, startMouseY } = transformState;
        const { clientX, clientY } = event.touches ? event.touches[0] : event;
        if (handle.includes('rotate')) { const currentAngle = Math.atan2(clientY - center.y, clientX - center.x); const angle = (currentAngle - startAngle); selectedElements.forEach((el, i) => applySingleTransform(el, { rotation: angle * 180 / Math.PI }, initialTransforms[i]));
        } else {
            const rotation = bbox.rotation * Math.PI / 180;
            const cos = Math.cos(-rotation), sin = Math.sin(-rotation);
            const rotatedDX = (clientX - startMouseX) * cos - (clientY - startMouseY) * sin;
            const rotatedDY = (clientX - startMouseX) * sin + (clientY - startMouseY) * cos;
            
            let sx=1, sy=1;
            if(bbox.width > 0) sx = (bbox.width + rotatedDX/zoom * (handle.includes('w') ? -1 : 1)) / bbox.width;
            if(bbox.height > 0) sy = (bbox.height + rotatedDY/zoom * (handle.includes('n') ? -1 : 1)) / bbox.height;
            if(event.shiftKey) sx = sy = Math.max(sx, sy);
            
            selectedElements.forEach((el, i) => { const t = initialTransforms[i]; const originX = t.cx + (handle.includes('w') ? t.width : 0); const originY = t.cy + (handle.includes('n') ? t.height : 0); applySingleTransform(el, { scaleX: sx, scaleY: sy, originX, originY }, t); });
        }
        updateUI(false);
    }
    function applySingleTransform(el, {dx=0, dy=0, scaleX=1, scaleY=1, rotation=0, originX, originY}, baseT) {
        const t = baseT || parseTransform(el.getAttribute('transform'));
        let matrix = new DOMMatrix();
        matrix = matrix.translate(t.tx + dx, t.ty + dy);
        if (originX !== undefined) { matrix = matrix.translate(originX, originY).scale(scaleX, scaleY).translate(-originX, -originY); }
        else { matrix = matrix.scale(t.sx * scaleX, t.sy * scaleY); }
        matrix = matrix.rotate(t.angle + rotation);
        el.setAttribute('transform', matrix.toString());
    }
    
    // --- HISTORIAL I SVG ---
    function loadSVG(code, doPushHistory = true) {
        try { const doc = new DOMParser().parseFromString(code, "image/svg+xml"); if(doc.querySelector('parsererror')) throw new Error('Codi SVG invàlid'); svgEl = doc.documentElement; svgWrapperEl.innerHTML = ''; svgWrapperEl.append(svgEl); if (doPushHistory) { history = [svgEl.outerHTML]; historyIndex = 0; } applyTransform(); updateUI(); updateHistoryButtons(); }
        catch (e) { console.error("Error al carregar SVG:", e); }
    }
    function pushHistory() { const currentState = svgEl.outerHTML; if (currentState === history[historyIndex]) return; if (historyIndex < history.length - 1) history.splice(historyIndex + 1); history.push(currentState); if (history.length > 50) history.shift(); historyIndex = history.length - 1; updateUI(); updateHistoryButtons(); }
    function undo() { if (historyIndex > 0) loadFromHistory(--historyIndex); }
    function redo() { if (historyIndex < history.length - 1) loadFromHistory(++historyIndex); }
    function loadFromHistory(index) { loadSVG(history[index], false); updateHistoryButtons(); }
    
    // --- UTILITATS ---
    function parseTransform(str) { const t = { tx:0, ty:0, angle:0, sx:1, sy:1, cx:0, cy:0 }; if(!str) return t; (str.match(/(\w+\(.*?\))/g) || []).forEach(p => { const [type, val] = p.split('('); const v = val.slice(0, -1).split(/[, ]+/).map(parseFloat); if (type==='translate'){t.tx=v[0]; t.ty=v[1]||0;} if (type==='rotate'){t.angle=v[0]; t.cx=v[1]||0; t.cy=v[2]||0;} if (type==='scale'){t.sx=v[0]; t.sy=v[1]!==undefined?v[1]:v[0];} }); return t; }
    function applyTransform() { if (svgWrapperEl) { svgWrapperEl.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; drawTransformBox(); } }
    const updateEditor = () => { if (document.activeElement !== editorEl && svgEl) { editorEl.value = svgEl.outerHTML; } };
    const updateHistoryButtons = () => { get('undoBtn').disabled = historyIndex <= 0; get('redoBtn').disabled = historyIndex >= history.length - 1; };
    function toggleColor(type) { const isStroke = type === 'stroke'; if(isStroke){ strokeColor = strokeColor === 'black' ? 'white' : 'black'; } else { fillColor = fillColor === 'transparent' ? 'black' : 'transparent'; } updateColorIndicators(); if(selectedElements.length > 0) { selectedElements.forEach(el => { const prop = isStroke ? 'stroke' : 'fill'; if(prop === 'fill' && el.tagName === 'line') return; el.setAttribute(prop, isStroke ? strokeColor : fillColor); }); pushHistory(); }}
    function updateColorIndicators() { get('strokeColorToggle').querySelector('.color-indicator').style.backgroundColor = strokeColor; const fillInd = get('fillColorToggle').querySelector('.color-indicator'); fillInd.style.backgroundColor = fillColor; fillInd.style.border = fillColor === 'transparent' ? '1px solid black' : 'none'; }
    function save() { if(!svgEl) return; const clone = svgEl.cloneNode(true); clone.querySelectorAll('.selected-indicator').forEach(el => el.classList.remove('selected-indicator')); const data = new Blob([clone.outerHTML], {type:'image/svg+xml'}); const a = document.createElement('a'); a.href = URL.createObjectURL(data); a.download = 'disseny.svg'; a.click(); URL.revokeObjectURL(a.href); }
    function triggerImport() { get('file-importer').click(); }
    function importFile(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (re) => loadSVG(re.target.result); reader.readAsText(file); e.target.value = ''; }
    let selectionBox;
    function createSelectionBox(x,y){ selectionBox = document.createElement('div'); selectionBox.id = 'selection-box'; Object.assign(selectionBox.style, {left:`${x}px`,top:`${y}px`}); previewEl.appendChild(selectionBox); selectionBox.startX=x; selectionBox.startY=y; }
    function updateSelectionBox(x,y){ if(!selectionBox)return; const w=x-selectionBox.startX, h=y-selectionBox.startY; Object.assign(selectionBox.style, {width:`${Math.abs(w)}px`,height:`${Math.abs(h)}px`,left:`${w<0?x:selectionBox.startX}px`,top:`${h<0?y:selectionBox.startY}px`}); }
    function removeSelectionBox(){ selectionBox?.remove(); selectionBox = null; }
    function selectInMarquee(){ if(!selectionBox)return; const selRect = selectionBox.getBoundingClientRect(); svgEl.querySelectorAll('rect,circle,line,path,g').forEach(el=>{ const elRect=el.getBoundingClientRect(); if(!(elRect.right<selRect.left||elRect.left>selRect.right||elRect.bottom<selRect.top||elRect.top>selRect.bottom)) toggleSelection(el); }); }
    
    // --- INICI DE L'APLICACIÓ ---
    initialize();
  </script>
</body>
</html>
